<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:barcode="clr-namespace:BarcodeScanning;assembly=BarcodeScanning.Native.Maui"
             x:Class="ScanPackage.CellScanPage"
             NavigationPage.HasNavigationBar="False"
             BackgroundColor="Black">

    <Grid>
        <!-- Camera view full screen -->
        <barcode:CameraView x:Name="BarcodeView"
                            OnDetectionFinished="OnBarcodesDetected"
                            CameraEnabled="True"
                            CameraFacing="Back"
                            VerticalOptions="FillAndExpand"
                            HorizontalOptions="FillAndExpand">
            <barcode:CameraView.GestureRecognizers>
                <PinchGestureRecognizer PinchUpdated="OnPinchUpdated" />
            </barcode:CameraView.GestureRecognizers>
        </barcode:CameraView>

        <!-- Custom overlay with rounded cutout (25% opacity) -->
        <GraphicsView x:Name="OverlayGraphics"
                      VerticalOptions="FillAndExpand"
                      HorizontalOptions="FillAndExpand"
                      InputTransparent="True" />

        <!-- Main Layout -->
        <Grid RowDefinitions="Auto,*,Auto">

            <!-- ==================== HEADER (giống DataEntryPage) ==================== -->
            <Grid Grid.Row="0" 
                  x:Name="HeaderGrid"
                  BackgroundColor="Transparent"
                  MinimumHeightRequest="50">
                <Grid ColumnDefinitions="Auto,*,Auto">
                    <!-- Back Button -->
                    <Border Grid.Column="0"
                            BackgroundColor="Transparent"
                            Padding="4"
                            StrokeThickness="0"
                            VerticalOptions="End"
                            Margin="0,15,23,11">
                        <Image Source="back_icon.svg"
                               MinimumWidthRequest="24"
                               MinimumHeightRequest="24"
                               Aspect="AspectFit"/>
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Tapped="OnCloseClicked"/>
                        </Border.GestureRecognizers>
                    </Border>

                    <!-- Title "Quét" -->
                    <Label Grid.Column="1"
                           Text="Quét"
                           FontSize="22"
                           FontAttributes="Bold"
                           TextColor="White"
                           VerticalOptions="End"
                           HorizontalOptions="Start"
                           Margin="0,0,0,12"/>

                    <!-- Flash Button - Circle with icon -->
                    <Grid Grid.Column="2"
                          WidthRequest="36"
                          HeightRequest="36"
                          VerticalOptions="End"
                          HorizontalOptions="End"
                          Margin="0,0,13,11">

                        <Ellipse x:Name="FlashCircle"
                                 Fill="White"
                                 WidthRequest="36"
                                 HeightRequest="36"
                                 HorizontalOptions="Center"
                                 VerticalOptions="Center"/>

                        <Image Source="flashlight.svg"
                               WidthRequest="24"
                               HeightRequest="24"
                               HorizontalOptions="Center"
                               VerticalOptions="Center"/>

                        <Grid.GestureRecognizers>
                            <TapGestureRecognizer Tapped="OnFlashClicked"/>
                        </Grid.GestureRecognizers>
                    </Grid>
                </Grid>
            </Grid>

            <!-- ==================== CAMERA VIEW WITH CROP OVERLAY ==================== -->
            <Grid Grid.Row="1"
                  VerticalOptions="FillAndExpand"
                  HorizontalOptions="FillAndExpand">

                <!-- Transparent crop area (scanning region) -->
                <Frame BackgroundColor="Transparent"
                       BorderColor="Transparent"
                       CornerRadius="20"
                       Padding="0"
                       HasShadow="False"
                       WidthRequest="372"
                       HeightRequest="220"
                       HorizontalOptions="Center"
                       VerticalOptions="Center"
                       InputTransparent="True">

                    <!-- White border frame for crop area -->
                    <Border Stroke="White"
                            StrokeThickness="3"
                            BackgroundColor="Transparent"
                            InputTransparent="True">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="20"/>
                        </Border.StrokeShape>
                    </Border>
                </Frame>
            </Grid>

            <!-- ==================== ZOOM SLIDER (BOTTOM) ==================== -->
            <Grid Grid.Row="2"
                  BackgroundColor="Transparent"
                  Padding="43,0,43,65"
                  ColumnDefinitions="Auto,*,Auto"
                  HeightRequest="90">

                <!-- Minus Button (decorative only) -->
                <Image Grid.Column="0"
                       Source="minus.svg"
                       WidthRequest="24"
                       HeightRequest="24"
                       VerticalOptions="Center"
                       HorizontalOptions="Center"
                       Margin="0,0,20,0"
                       InputTransparent="True"/>

                <!-- Zoom Slider with custom design -->
                <Grid Grid.Column="1" 
                      VerticalOptions="Center">

                    <!-- Track line -->
                    <BoxView Color="#707070"
                             HeightRequest="1"
                             VerticalOptions="Center"
                             HorizontalOptions="FillAndExpand"
                             Margin="0"/>

                    <!-- Slider (invisible track, only thumb visible) -->
                    <Slider x:Name="ZoomSlider"
                            Minimum="1"
                            Maximum="5"
                            Value="1"
                            MinimumTrackColor="Transparent"
                            MaximumTrackColor="Transparent"
                            ThumbColor="Transparent"
                            VerticalOptions="Center"
                            ValueChanged="OnZoomChanged"
                            Margin="-12,0,-12,0"/>

                    <!-- Custom Thumb (2 circles) -->
                    <Grid x:Name="CustomThumb"
                          WidthRequest="31"
                          HeightRequest="31"
                          HorizontalOptions="Start"
                          VerticalOptions="Center"
                          InputTransparent="True">

                        <!-- Outer circle (25% opacity) -->
                        <Ellipse Fill="#40000000"
                                 WidthRequest="31"
                                 HeightRequest="31"
                                 HorizontalOptions="Center"
                                 VerticalOptions="Center"/>

                        <!-- Inner circle (white) -->
                        <Ellipse Fill="White"
                                 WidthRequest="25"
                                 HeightRequest="25"
                                 HorizontalOptions="Center"
                                 VerticalOptions="Center"/>
                    </Grid>
                </Grid>

                <!-- Plus Button (decorative only) -->
                <Image Grid.Column="2"
                       Source="plus.svg"
                       WidthRequest="24"
                       HeightRequest="24"
                       VerticalOptions="Center"
                       HorizontalOptions="Center"
                       Margin="20,0,0,0"
                       InputTransparent="True"/>
            </Grid>

        </Grid>
    </Grid>
</ContentPage>
